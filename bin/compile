#!/bin/bash
# usage: bin/compile <build-dir> <cache-dir>

set -eo pipefail

indent() {
  sed -u 's/^/       /'
}

mkdir -p "$1" "$2"
build=$(cd "$1/" && pwd)
cache=$(cd "$2/" && pwd)
profile="$1/.profile.d"
prefix="$1/.rubinius"
yaml="http://pyyaml.org/download/libyaml/yaml-0.1.4.tar.gz"

mkdir -p $prefix

export PATH=$prefix/bin:$PATH
export LANG=en_US.UTF-8
export LIBRARY_PATH=$prefix/lib
export LD_LIBRARY_PATH=$prefix/lib

pushd $cache

echo "-----> Installing PyYAML"
curl $yaml | tar zxf - | indent
pushd yaml*
./configure --prefix=$prefix | indent
make install | indent
popd

echo "-----> Cloning Rubinius master"
git clone git://github.com/rubinius/rubinius.git --quiet --depth 1 | indent

pushd rubinius

set +e

echo "-----> Configuring Rubinius"
./configure --default-version 19 --prefix=$prefix \
  --with-lib-dir $prefix/lib --with-include-dir $prefix/include | indent

if [ $? != 0 ]; then
  echo
  echo "-----> Build failed! Here's configure.log:"
  cat configure.log | indent
  exit 1
fi

set -e

echo "-----> Building & installing Rubinius"
CXXFLAGS=-fPIC CFLAGS=fPIC rake install | indent

popd

popd

echo "-----> Bundling gems"
gem install bundler
bundle

echo "-----> Building runtime environment"
mkdir -p $profile
echo 'export PATH="$HOME/bin:$HOME/.rubinius/bin:$PATH' > $profile/rubinius.sh
