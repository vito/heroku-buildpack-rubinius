#!/bin/bash
# usage: bin/compile <build-dir> <cache-dir>

set -eo pipefail

indent() {
  sed -u 's/^/       /'
}

mkdir -p "$1" "$2"
build=$(cd "$1/" && pwd)
cache=$(cd "$2/" && pwd)
profile="$1/.profile.d"
prefix="$1/.rubinius"
yaml="http://pyyaml.org/download/libyaml/yaml-0.1.4.tar.gz"

mkdir -p $profile $prefix

export PATH=$prefix/bin:$PATH
export LANG=en_US.UTF-8
export LIBRARY_PATH=$prefix/lib
export LD_LIBRARY_PATH=$prefix/lib

pushd $cache

curl $yaml | tar zxf - | indent
pushd yaml*
./configure --prefix=$prefix | indent
make install | indent
popd

git clone git://github.com/rubinius/rubinius.git --depth 1 | indent
pushd rubinius
set +e
./configure --default-version 19 --prefix=$prefix | indent
if [ $? != 0 ]; then
  echo
  echo "Build failed! Here's configure.log:" | indent
  cat configure.log | indent
  exit 1
fi
set -e
rake install | indent
popd

popd

cat > $profile/rubinius.sh <<EOF
export PATH=$HOME/.rubinius/bin:$PATH
EOF
