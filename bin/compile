#!/bin/bash
# usage: bin/compile <build-dir> <cache-dir>

set -eo pipefail

indent() {
  sed -u 's/^/       /'
}

mkdir -p "$1" "$2"
build=$(cd "$1/" && pwd)
cache=$(cd "$2/" && pwd)
profile="$build/.profile.d"
prefix="$build/.rubinius"
yaml="http://pyyaml.org/download/libyaml/yaml-0.1.4.tar.gz"

mkdir -p $prefix

export PATH=$prefix/bin:$PATH
export LANG=en_US.UTF-8
export LIBRARY_PATH=$prefix/lib
export LD_LIBRARY_PATH=$prefix/lib

pushd $cache

echo "-----> Installing PyYAML"
curl $yaml | tar zxf - | indent
pushd yaml*
./configure --prefix=$prefix | indent
make install | indent
popd

echo "-----> Cloning Rubinius master"
git clone git://github.com/rubinius/rubinius.git --quiet --depth 1
pushd rubinius

set +e

echo "-----> Configuring Rubinius"
./configure --enable-version 19 --default-version 19 --prefix=$prefix \
  --with-lib-dir $prefix/lib --with-include-dir $prefix/include | indent

if [ $? != 0 ]; then
  echo "-----> Build failed! Here's configure.log:"
  cat configure.log | indent
  exit 1
fi

set -e

echo "-----> Building & installing Rubinius"
CXXFLAGS=-fPIC CFLAGS=fPIC rake install | indent

popd

popd

echo "-----> Adding Rubinius gems directory to \$PATH"
export PATH=$prefix/gems/1.9/bin:$PATH

echo "-----> PATH: $PATH"

echo "-----> Installing Bundler with `which gem`"
pushd $build
gem install bundler | indent

echo "-----> Bundling with `which bundle`"
bundle | indent
popd

echo "-----> Building runtime environment"
mkdir -p $profile
echo 'export PATH="$HOME/bin:$HOME/.rubinius/gems/1.9/bin:$HOME/.rubinius/bin:$PATH"' > $profile/rubinius.sh

echo "-----> Testing Atomy"
bundle exec atomy -e 'use("atomy"), puts("hi")'

echo '-----> Done!'
